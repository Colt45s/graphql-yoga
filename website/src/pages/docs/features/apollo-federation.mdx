---
description:
  Learn how to use GraphQL Yoga with Apollo Federation to build a gateway server and a federated
  service.
---

import { Callout } from '@theguild/components'

# Apollo Federation

[Apollo Federation](https://apollographql.com/docs/federation) is a specification that applies
microservice architecture through GraphQL APIs.

## Gateway

### Installation for Gateway

```sh npm2yarn
npm i @graphql-tools/federation graphql-yoga
```

### Example Gateway

```ts
import { createServer } from 'http'
import { createYoga } from 'graphql-yoga'
import { getStitchedSchemaFromSupergraphSdl } from '@graphql-tools/federation'

const yoga = createYoga({
  schema: getStitchedSchemaFromSupergraphSdl({
    supergraphSdl: readFileSync('./supergraph.graphql', 'utf-8')
  })
})

// Start the server and explore http://localhost:4000/graphql
const server = createServer(yoga)
server.listen(4000, () => {
  console.info('Server is running on http://localhost:4000/graphql')
})
```

## Subscriptions over WS

By default, `@graphql-tools/federation` handles subscriptions per
[GraphQL over SSE](https://github.com/enisdenjo/graphql-sse/blob/master/PROTOCOL.md). But if you
want to use WebSockets between services and the gateway, you can use the
`@graphql-tools/executor-graphql-ws`.

### Installation for Gateway

```sh npm2yarn
npm i @graphql-tools/executor-graphql-ws @graphql-tools/executor-http
```

### Example Gateway

```ts
import { buildGraphQLWSExecutor } from '@graphql-tools/executor-graphql-ws'
import { buildHTTPExecutor } from '@graphql-tools/executor-http'

const yoga = createYoga({
  schema: getStitchedSchemaFromSupergraphSdl({
    supergraphSdl: readFileSync('./supergraph.graphql', 'utf-8'),
    onExecutor({ endpoint }) {
      const httpExecutor = buildHTTPExecutor({
        endpoint
      })
      const wsExecutor = buildGraphQLWSExecutor({
        url: endpoint
      })
      return function executor(executionRequest) {
        if (executionRequest.operationType === 'subscription') {
          return wsExecutor(executionRequest)
        }
        return httpExecutor(executionRequest)
      }
    }
  })
})
```

## Federation Service

You don't need any extra plugins for Yoga for Federation Service.

### Installation

```sh npm2yarn
npm i graphql-yoga @graphql-tools/federation graphql
```

### Example User Service

```ts
const { parse } = require('graphql')
const { buildSubgraphSchema } = require('@graphql-tools/federation')
const { createYoga } = require('graphql-yoga')
const { createServer } = require('http')

const typeDefs = parse(/* GraphQL */ `
  type Query {
    me: User
  }

  type User @key(fields: "id") {
    id: ID!
    username: String
  }
`)

const resolvers = {
  Query: {
    me() {
      return { id: '1', username: '@ava' }
    }
  },
  User: {
    __resolveReference(user, { fetchUserById }) {
      return fetchUserById(user.id)
    }
  }
}
const yoga = createYoga({
  schema: buildSubgraphSchema({ typeDefs, resolvers })
})

const server = createServer(yoga)

server.listen(4001, () => {
  console.log(`ðŸš€ Server ready at http://localhost:4001`)
})
```

## Federated tracing

Inject additional metrics for
[Apollo's federated tracing](https://www.apollographql.com/docs/federation/metrics/).

You'll need the `@graphql-yoga/plugin-apollo-inline-trace` Yoga plugin for this.

### Installation

```sh npm2yarn
npm i graphql-yoga @graphql-yoga/plugin-apollo-inline-trace graphql
```

### Example Federated tracing

```ts
import { createServer } from 'http'
import { createYoga } from 'graphql-yoga'
import { useApolloInlineTrace } from '@graphql-yoga/plugin-apollo-inline-trace'

const yoga = createYoga({
  plugins: [
    useApolloInlineTrace()
    // ...rest of your Apollo federation plugins
  ]
})

// Start the server and explore http://localhost:4000/graphql
const server = createServer(yoga)
server.listen(4000, () => {
  console.info('Server is running on http://localhost:4000/graphql')
})
```

## Working Example

Check our
[working example](https://github.com/dotansimha/graphql-yoga/tree/main/examples/apollo-federation)
to try it out.
